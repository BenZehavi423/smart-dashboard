{% extends "base.html" %}

{% block title %}
Register
{% endblock %}

{% block content %}
<div class="start-pages auth-page">
  <h1 class="page-title">Sign Up</h1>

  <form class="auth-form" method="POST" action="{{ url_for('auth.register') }}" id="registerForm">
    <div class="form-row">
      <label for="username">Username</label>
      <input type="text" id="username" name="username" required />
    </div>
    <div class="form-row">
      <label for="password">Password</label>
      <input type="password" id="password" name="password" required />
    </div>
    <button type="submit" class="button green">Sign Up</button>
  </form>

  <script>
    document.addEventListener('DOMContentLoaded', function() {
      const form = document.getElementById('registerForm');
      const usernameField = document.getElementById('username');
      const passwordField = document.getElementById('password');
      
      // Show initial requirements
      window.validator.showDetailedRequirements(usernameField, window.validator.getUsernameRequirements(''));
      window.validator.showDetailedRequirements(passwordField, window.validator.getPasswordRequirements(''));
      
      // Update requirements on input
      usernameField.addEventListener('input', function() {
        const requirements = window.validator.getUsernameRequirements(this.value);
        window.validator.showDetailedRequirements(this, requirements);
      });
      
      passwordField.addEventListener('input', function() {
        const requirements = window.validator.getPasswordRequirements(this.value);
        window.validator.showDetailedRequirements(this, requirements);
      });
      
      // Handle form submission with AJAX
      form.addEventListener('submit', function(e) {
        e.preventDefault();
        
        const formData = new FormData(form);
        const username = formData.get('username');
        const password = formData.get('password');
        
        // Client-side validation
        const usernameValid = window.validator.isFieldValid(usernameField, { type: 'username', required: true });
        const passwordValid = window.validator.isFieldValid(passwordField, { type: 'password', required: true });
        
        if (!usernameValid || !passwordValid) {
          window.validator.showErrorNotification('Please fix the validation errors before submitting.');
          return;
        }
        
        // Submit via AJAX
        fetch(form.action, {
          method: 'POST',
          body: formData,
          headers: {
            'X-Requested-With': 'XMLHttpRequest'
          }
        })
        .then(response => {
          if (response.redirected) {
            // Success - redirect to the target page
            window.location.href = response.url;
          } else {
            // Error - try to parse as JSON first
            return response.json().catch(() => {
              // If not JSON, try as text
              return response.text().then(text => {
                // Try to parse as HTML and extract flash messages
                const parser = new DOMParser();
                const doc = parser.parseFromString(text, 'text/html');
                const flashMessages = doc.querySelectorAll('.flash-item');
                
                if (flashMessages.length > 0) {
                  const errorMessage = Array.from(flashMessages)
                    .filter(msg => msg.classList.contains('error'))
                    .map(msg => msg.textContent)
                    .join(' ');
                  return { error: errorMessage };
                }
                return { error: 'An error occurred. Please try again.' };
              });
            });
          }
        })
        .then(data => {
          if (data && data.error) {
            window.validator.showErrorNotification(data.error);
          }
        })
        .catch(error => {
          console.error('Error:', error);
          window.validator.showErrorNotification('An error occurred. Please try again.');
        });
      });
    });
  </script>

  <p class="auth-switch">Already have an account?<a class="button blue" href="{{ url_for('auth.login') }}">Log In</a></p>
</div>
{% endblock %}
