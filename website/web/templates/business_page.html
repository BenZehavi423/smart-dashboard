{% extends "base.html" %}
{% block title %}
Dashboard
{% endblock %}

{% block head %}
<link rel="stylesheet" href="{{ url_for('static', filename='business_page.css') }}">
{% endblock %}

{% block content %}

<h1 class="page-title">{{ business.name }}</h1> 

<div class="dashboard-section">
  <h2>Details</h2>
  {% if user._id in business.editors %}
    <div class="section-header">
      <a href="{{ url_for('views.edit_business_details', business_name=business.name) }}" class="btn btn-primary btn-sm">Edit</a>
    </div>
  {% endif %}
  <ul>
    <li><strong>Name:</strong> {{ business.name }}</li>
    {% if business.address %} <li><strong>Address:</strong> {{ business.address }}</li> {% endif %}
    {% if business.phone %} <li><strong>Phone:</strong> {{ business.phone }}</li> {% endif %}
    {% if business.email %} <li><strong>Email:</strong> {{ business.email }}</li> {% endif %}
    <li><strong>Owner:</strong> {{ owner }}</li>
  </ul>
</div>

{% if user._id == business.owner %}
<div class="dashboard-section">
  <h2>Manage Editors</h2>
  <div class="editor-management">
    <div class="add-editor-form">
      <h3>Add Editor</h3>
      <form method="POST" action="{{ url_for('views.add_editor', business_name=business.name) }}">
        <div class="form-group">
          <label for="username">Username:</label>
          <input type="text" id="username" name="username" required>
          <small>Enter the username of the person you want to give editing privileges to</small>
        </div>
        <button type="submit" class="btn btn-primary">Add Editor</button>
      </form>
    </div>
    
    <div class="current-editors">
      <h3>Current Editors</h3>
      <ul class="editors-list">
        {% for editor_id in business.editors %}
          {% set editor_user = get_editor_user(editor_id) %}
          <li class="editor-item">
            <span class="editor-name">{{ editor_user.username if editor_user else 'Unknown User' }}</span>
            {% if editor_id != business.owner %}
              <form method="POST" action="{{ url_for('views.remove_editor', business_name=business.name) }}" style="display: inline;">
                <input type="hidden" name="editor_id" value="{{ editor_id }}">
                <button type="submit" class="btn btn-danger btn-sm" onclick="return confirm('Are you sure you want to remove this editor?')">Remove</button>
              </form>
            {% else %}
              <span class="owner-badge">Owner</span>
            {% endif %}
          </li>
        {% endfor %}
      </ul>
    </div>
  </div>
</div>
{% endif %}

<div class="dashboard-section">
  <h2>Plots</h2>
  {% if plots %}
  <div class="plot-gallery">
    <div class="plot-container">
      <button class="nav-btn prev-btn" onclick="previousPlot()" id="prevBtn">‹</button>
      <div class="plot-window">
        <div class="plot-header">
          <h3 id="currentPlotName">Plot Name</h3>
          {% if user._id in business.editors %}
            <button class="download-btn" onclick="downloadCurrentPlot()" title="Download Image">Download</button>
          {% endif %}
        </div>
        <img id="currentPlot" src="" alt="Plot" style="max-width: 100%; height: auto;">
      </div>
      <button class="nav-btn next-btn" onclick="nextPlot()" id="nextBtn">›</button>
    </div>
    <div class="plot-counter">
      <span id="plotCounter">1/{{ plots|length }}</span>
    </div>
  </div>
  {% else %}
  <div class="no-plots">
    <p>No plots yet. Upload files to get started.</p>
  </div>
  {% endif %}
  {% if user._id in business.editors %}
    <div class="plot-actions">
      <a href="{{ url_for('views.edit_plots', business_name=business.name) }}" class="button blue">Edit Plots</a>
      <a href="{{ url_for('views.analyze_data', business_name=business.name) }}" class="button green">Analyze Data</a>
    </div>
  {% endif %}
</div>

{% if user._id in business.editors %}
  <div class="dashboard-section">
    <h2>Files</h2>
    <a href="{{ url_for('views.upload_files', business_name=business.name) }}" class="button blue">Upload New Files</a>
    {% if files %}
      <ul>
        {% for file in files %}
          <li>{{ file.filename }}</li>
        {% endfor %}
      </ul>
    {% endif %}
  </div>
{% endif %}

<link rel="stylesheet" href="{{ url_for('static', filename='plots.css') }}">
<script src="{{ url_for('static', filename='profile.js') }}"></script>
<script>
document.addEventListener('DOMContentLoaded', function() {
  const plotsData = {{ plots|tojson }};
  initializePlots(plotsData);
  const urlParams = new URLSearchParams(window.location.search);
  if (urlParams.get('success') === 'changes_saved') {
    showTemporarySuccessMessage('Changes Saved', 'Your changes are now live.', 4000);
    window.history.replaceState({}, document.title, window.location.pathname);
  }
});

document.getElementById('llm-form').addEventListener('submit', function(e) {
  e.preventDefault();
  const query = document.getElementById('llm-query').value;
  fetch('/ask_llm', {
    method: 'POST',
    headers: {'Content-Type': 'application/json'},
    body: JSON.stringify({ query })
  })
  .then(response => response.json())
  .then(data => {
    document.getElementById('llm-response').textContent = data.error ? 'Error: ' + data.error : data.response;
  })
  .catch(() => {
    document.getElementById('llm-response').textContent = 'An error occurred.';
  });
});
</script>

{% endblock %}
